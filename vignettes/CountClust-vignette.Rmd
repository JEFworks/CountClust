---
title: "CountClust- R package for clustering of counts data"
author: "Kushal K Dey    Matthew Stephens"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Installation

To download and install this package, 

```
install.packages("devtools")
library(devtools)
install_github("kkdey/CountClust")
```

Load the package in R

```
library(CountClust)
```

## Data Format

**CountClust** takes as input a counts table with samples along the rows (which we want to cluster) and features along the columns (which represents the dimensionality of the clusters). The package fits a topic mixed membersjip model on the samples based on these features and then visulaize and annotate these clusters to extract the top features driving each cluster.

## Data Preprocessing

Assume `data` represents the counts table with n rows (samples) and p columns(features). As data preprocessing step, once can delete or substitute the columns that contain NAs. If for a feature, the proportion of 
NAs is greater than threshold proportion (`thresh_prop`), then we remove the feature, otherwise we use MAR substitution scheme using the distribution of the non NA values for the feature. 

```{r, echo=TRUE, eval=FALSE}
handleNA(data, thresh_prop=0)
handleNA(data, thresh_prop=0.2)
```

Next we remove features which are too sparse (sparsity threshold provided by the user).This function deals with zero counts in the counts dataset. If for a feature, the proportion of zeros across the samples is greater than filter_prop, then we remove the feature.

```{r, echo=TRUE, eval=TRUE}
RemoveSparseFeatures(data,filter_prop=0.5)
```

## Model fitting

Once the data preprocessing step is completed, we perform the mixed membership clustering of the samples based on the counts expression values across the features. We use the R package [maptpx](https://cran.r-project.org/web/packages/maptpx/index.html) package due to Matt Taddy. The *StructureObj()* function performs this step and saves the model output as rda file in the path provided by the user.

Assume that `metadata` is a n (samples) by t (metadata labels) matrix that contains values for each metadata recorded in each column of this matrix. 

We load the brain metadata for our example.  

```
metadata <- cbind.data.frame(read.table("test/metadata_brain.txt")[,3]);
colnames(metadata) <- "brain_labs"
dim(metadata)
```

Before applying the model, create the directories to save the rda file and the cluster plots.

```
if(!dir.exists("test/Structure")) dir.create("test/Structure")
if(!dir.exists("test/Structure")) dir.create("test/Structure")
```

If the user wants to fit clustering for 2,3,4

```{r, echo=TRUE, eval=TRUE}
clus_vec <- 3;
StructureObj(data, nclus_vec=clus_vec, samp_metadata = metadata, tol=0.1, batch_lab = NULL,
             plot=TRUE, path_rda="test/topics_data.rda", path_struct="test/Structure")
```

```{r, echo=TRUE, eval=FALSE} 
clus_vec <- c(2,3,4);
StructureObj(data, nclus_vec=clus_vec, samp_metadata = metadata, tol=0.1, batch_lab = NULL,
             plot=FALSE, path_rda="test/topics_data.rda", path_struct="test/Structure")
                         
```

If `plot=TRUE`, the above function will create the Structure plot visualization of the clusters, one for each of the cluster values selected and arrangement of bars due to each of the `metadata` columns. 


## Example Use

Load the counts data (samples along the rows, variables or features along the columns) in R. Here we use a test data comprising of the brain samples in GTEX V6 data

```
brain_data <- t(data.frame(data.table::fread("test/cis_gene_expression_brain.txt"))[,-(1:2)]);
brain_data <- brain_data[,1:1000];
write.table(brain_data,"test/cis_gene_expression_brain.txt");
dim(brain_data)
```
Next we load the brain metadata 

```
metadata <- cbind.data.frame(read.table("test/metadata_brain.txt")[,3]);
colnames(metadata) <- "brain_labs"
dim(metadata)
```

### Model fit and Visualization

We  apply the StructureObj function to fit the topic model (due to the **maptpx** package of Matt Taddy) 
and plot the Structure plot. 

```
if(!dir.exists("test/Structure")) dir.create("test/Structure")
StructureObj(brain_data, nclus_vec=3, samp_metadata = metadata, tol=0.1, batch_lab = NULL,
             plot=TRUE, path_rda="test/topics_data.rda", path_struct="test/Structure")
```

This function will output two things:

-  a rda file containing all topic model information named "test/topics_data.rda" 
-  The Structure plot for K=3 arranged by the metadata provided in test/Structure. If samp_metadata is a matrix 
   with several columns, then Structure plots arranged by each column in samp_metadata will be created.

The rda file contains the W (the topic proportion matrix) and T (topic distribution) files, so if you need to change
the Structure plot, you do not need to rerun the StructureObj fit again and you can just load the W matrix in rda 
file into out StrutureObj_omega() function.

```
brain_structure <- get(load("test/topics_data.rda"));
StructureObj_omega(brain_structure[[1]]$omega, samp_metadata = brain_metadata, 
                          batch_lab = NULL, path_struct="test/Structure",
                          control=list(cex.axis=1, struct.width=500, struct.height=500))
```

Then go to `test/Structure` and you will be able to see the Structure plot for K=3 with width and the height
of the Structure plot modified.

The Structure plot generated looks like the following

<img src='test/Structure/clus_3/struct_clus_3_labs.png' style="width:550px;height:300px;">


### Cluster annotations

To extract the variables that drive the clusters (cluster annotation)

```
theta <- brain_structure[[1]]$theta;
features <- ExtractTopFeatures(theta,top_features=50,method="poisson")
```
It will provide you with a list of top 50 variables/features per cluster that drive that cluster to be
different from the rest.

## Licenses

The CountClust package is distributed under [GPL - General Public License (>= 2)]

## Contact

For any queries, contact [kkdey@uchicago.edu](kkdey@uchicago.edu)

## Acknowledgements

- Joyce Hsiao
- Raman Shah


